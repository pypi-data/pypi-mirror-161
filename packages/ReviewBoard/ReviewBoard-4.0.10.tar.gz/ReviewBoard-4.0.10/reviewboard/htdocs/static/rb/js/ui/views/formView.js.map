{"version":3,"sources":["formView.es6.js"],"names":[],"mappings":"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","file":"formView.js","sourcesContent":["/**\n * A view for managing state on a form.\n *\n * This provides some standard behavior for setting up form widgets and\n * handling collapsable fieldsets, along with managing subforms.\n */\nRB.FormView = Backbone.View.extend({\n    events: {\n        'click .rb-c-form-fieldset__toggle': '_onToggleFieldSetClicked',\n    },\n\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        this._$subforms = null;\n        this._subformsByGroup = {};\n        this._formWidgetsInitialized = false;\n    },\n\n    /**\n     * Render the view.\n     *\n     * This will set up any subforms that might be available within the form.\n     *\n     * Returns:\n     *     RB.FormView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._$subforms = this.$('.rb-c-form-fieldset.-is-subform');\n\n        if (this._$subforms.length > 0) {\n            this._setupSubforms();\n        }\n\n        this.setupFormWidgets();\n\n        return this;\n    },\n\n    /**\n     * Set up state for widgets on the form.\n     *\n     * This will ensure that widgets are set up correctly on the form, or on\n     * a part of the form. This will take care to re-initialize widgets if\n     * they've already been initialized before (useful when dynamically adding\n     * new sections of a form).\n     *\n     * This supports only a few known types of widgets (Django date/time\n     * widgets and related object selectors).\n     *\n     * Args:\n     *     $el (jQuery, optional):\n     *         A starting point for finding the widgets. If not provided, all\n     *         widgets in the form will be set up.\n     */\n    setupFormWidgets($el) {\n        if ($el === undefined) {\n            $el = this.$el;\n        }\n\n        /*\n         * Update some state for Django widgets. We've quite possibly made use\n         * of widgets in the form that need to be initialized, and Django\n         * doesn't have much fine-grained support for doing this, so we need\n         * to take a heavy-handed approach.\n         *\n         * Django (up through 3.0 at least) performs similar logic.\n         */\n        if (window.DateTimeShortcuts &&\n            $el.find('.datetimeshortcuts').length > 0) {\n            if (this._formWidgetsInitialized) {\n                /*\n                 * Yep, we have to remove *all* of these... DateTimeShortcuts\n                 * has no granular widget support.\n                 */\n                $('.datetimeshortcuts').remove();\n            }\n\n            DateTimeShortcuts.init();\n        }\n\n        if (window.SelectFilter) {\n            $el.find('.selectfilter').each((i, el) => {\n                const parts = el.name.split('-');\n                SelectFilter.init(el.id, parts[parts.length - 1], false);\n            });\n\n            $el.find('.selectfilterstacked').each((i, el) => {\n                const parts = el.name.split('-');\n                SelectFilter.init(el.id, parts[parts.length - 1], true);\n            });\n        }\n\n        this._formWidgetsInitialized = true;\n    },\n\n    /**\n     * Set the visibility of one or more subforms.\n     *\n     * This will toggle visibility of a single subform, hide all subforms,\n     * or hide all subforms except one.\n     *\n     * Args:\n     *     options (object):\n     *         Options to control visibility.\n     *\n     * Option Args:\n     *     group (string):\n     *         The registered group for the subforms.\n     *\n     *     hideOthers (boolean):\n     *         Whether to hide any subforms other than the one specified by\n     *         ``subformID``.\n     *\n     *     subformID (string):\n     *         A single subform to set the visibility state for. If not\n     *         provided, this will toggle visibility of all subforms in the\n     *         group.\n     *\n     *     visible (boolean):\n     *         Whether to make the selected subform visible. This is only used\n     *         if ``hideOthers`` is not provided.\n     */\n    setSubformVisibility(options) {\n        console.assert(_.isObject(options),\n                       'An options object must be provided.');\n\n        const group = options.group;\n        const subformID = options.subformID;\n        const visible = options.visible;\n\n        console.assert(group, 'Missing option \"group\"');\n\n        const subformIDs = this._subformsByGroup[group];\n        console.assert(subformIDs, `Invalid subform group ${group}`);\n\n        if (options.hideOthers || !subformID) {\n            _.each(subformIDs, ($subform, id) => {\n                const isHidden = (subformID === undefined\n                                  ? !visible\n                                  : (id !== subformID));\n\n                $subform.prop({\n                    disabled: isHidden,\n                    hidden: isHidden,\n                });\n            });\n        } else {\n            console.assert(visible !== undefined, 'Missing option \"visible\"');\n\n            const $subform = subformIDs[subformID];\n            console.assert($subform, `Invalid subform ID ${subformID}`);\n\n            $subform.prop({\n                disabled: !visible,\n                hidden: !visible,\n            });\n        }\n    },\n\n    /**\n     * Set up state and event handlers for subforms.\n     *\n     * This will begin tracking all the subforms on the page, and connect\n     * subform visibility to any associated controllers.\n     */\n    _setupSubforms() {\n        const configuredControllers = {};\n\n        this._$subforms.each((i, subformEl) => {\n            const $subform = $(subformEl);\n            const controllerID = $subform.data('subform-controller');\n            const subformID = $subform.data('subform-id');\n            let group = $subform.data('subform-group');\n            let $controller;\n\n            if (!subformID) {\n                console.error('Subform %o is missing data-subform-id=',\n                              subformEl);\n                return;\n            }\n\n            if (!group && !controllerID) {\n                console.error(\n                    'Subform %o is missing either data-subform-group= ' +\n                    'or data-subform-controller=',\n                    subformEl);\n                return;\n            }\n\n            /*\n             * If we have a controller ID provided, look it up and ensure\n             * we're using the right group.\n             */\n            if (controllerID) {\n                $controller = this.$(`#${controllerID}`);\n\n                console.assert($controller.length === 1,\n                               `Missing controller #${controllerID}`);\n\n                const controllerGroup =\n                    $controller.data('subform-group');\n\n                /*\n                 * If the subform specifies an explicit group, and it\n                 * specified a controller, make sure they match up. While\n                 * we could work around an issue here, we'd rather make the\n                 * developer fix their code.\n                 */\n                if (group === undefined) {\n                    group = controllerGroup;\n                } else if (controllerGroup !== group) {\n                    console.error('Subform %o and controller %s have ' +\n                                  'different values for data-subform-group',\n                                  subformEl, controllerID);\n                    return;\n                }\n            }\n\n            /* Register the subforms so that they can be looked up later. */\n            if (!this._subformsByGroup.hasOwnProperty(group)) {\n                this._subformsByGroup[group] = {};\n            }\n\n            this._subformsByGroup[group][subformID] = $subform;\n\n            /*\n             * If we have a controller associated, set the current subform's\n             * visibility based on that value, and listen for changes.\n             */\n            if ($controller) {\n                this.setSubformVisibility({\n                    group: group,\n                    subformID: subformID,\n                    visible: $controller.val() === subformID,\n                });\n\n                if (!configuredControllers[controllerID]) {\n                    configuredControllers[controllerID] = true;\n\n                    $controller.on('change', () => this.setSubformVisibility({\n                        group: group,\n                        subformID: $controller.val(),\n                        visible: true,\n                        hideOthers: true,\n                    }));\n                }\n            }\n        });\n    },\n\n    /**\n     * Handle the showing or collapsing of a fieldset.\n     *\n     * This will set the appropriate state on the fieldset to show or hide\n     * the content.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event on the Show/Hide button.\n     */\n    _onToggleFieldSetClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const $toggle = $(e.target);\n        const $fieldset = $toggle.closest('.rb-c-form-fieldset');\n\n        if ($fieldset.hasClass('-is-collapsed')) {\n            $fieldset.removeClass('-is-collapsed');\n            $toggle.text(gettext('(Hide)'));\n        } else {\n            $fieldset.addClass('-is-collapsed');\n            $toggle.text(gettext('(Show)'));\n        }\n    },\n});\n"]}
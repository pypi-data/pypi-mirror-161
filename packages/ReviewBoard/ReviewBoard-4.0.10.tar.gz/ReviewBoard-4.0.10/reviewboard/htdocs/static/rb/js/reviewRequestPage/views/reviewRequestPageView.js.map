{"version":3,"sources":["reviewRequestPageView.es6.js"],"names":[],"mappings":"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","file":"reviewRequestPageView.js","sourcesContent":["(function() {\n\n\nconst commentTypeToIDPrefix = {\n    diff: '',\n    file: 'f',\n    screenshot: 's',\n};\n\n\n/**\n * Manages the review request page.\n *\n * This manages all the reviews on the page, diff fragment loading, and\n * other functionality needed for the main review request page.\n */\nRB.ReviewRequestPage.ReviewRequestPageView = RB.ReviewablePageView.extend({\n    events: _.extend({\n        'click #collapse-all': '_onCollapseAllClicked',\n        'click #expand-all': '_onExpandAllClicked',\n    }, RB.ReviewablePageView.prototype.events),\n\n    /**\n     * Initialize the page.\n     */\n    initialize() {\n        RB.ReviewablePageView.prototype.initialize.apply(this, arguments);\n\n        this._entryViews = [];\n        this._entryViewsByID = {};\n        this._rendered = false;\n        this._issueSummaryTableView = null;\n\n        const reviewRequest = this.model.get('reviewRequest');\n\n        this.diffFragmentQueue = new RB.DiffFragmentQueueView({\n            reviewRequestPath: reviewRequest.get('reviewURL'),\n            containerPrefix: 'comment_container',\n            queueName: 'diff_fragments',\n            el: document.getElementById('content'),\n            diffFragmentViewOptions: {\n                collapsible: true,\n            },\n        });\n\n        /*\n         * Listen for when a new set of updates have been processed. After\n         * processing, this will attempt to load any new diff fragments that\n         * may have been added in any updated views.\n         */\n        this.listenTo(this.model, 'updatesProcessed',\n                      () => this.diffFragmentQueue.loadFragments());\n\n        /*\n         * Listen for updates to any entries on the page. When updated,\n         * we'll store the collapse state on the entry so we can re-apply it\n         * after. We listen to the other events that are part of the update so\n         * we can update the DOM and restore state at the correct time.\n         */\n        this.listenTo(this.model, 'applyingUpdate:entry', (metadata, html) => {\n            const entryID = metadata.entryID;\n            const entryView = this._entryViewsByID[entryID];\n            const collapsed = entryView.isCollapsed();\n\n            this._onApplyingUpdate(entryView, metadata);\n\n            this.listenToOnce(\n                this.model,\n                `appliedModelUpdate:entry:${entryID}`,\n                (metadata, html) => this._reloadView(entryView, html));\n\n            this.listenToOnce(\n                this.model,\n                `appliedUpdate:entry:${entryID}`,\n                metadata => {\n                    this._onAppliedUpdate(entryView, metadata);\n\n                    if (collapsed) {\n                        entryView.collapse();\n                    } else {\n                        entryView.expand();\n                    }\n                });\n        });\n    },\n\n    /**\n     * Render the page.\n     *\n     * Returns:\n     *     RB.ReviewRequestPage.ReviewRequestPageView:\n     *     This object, for chaining.\n     */\n    render() {\n        RB.ReviewablePageView.prototype.render.call(this);\n\n        /*\n         * Render each of the entries on the page.\n         */\n        this._entryViews.forEach(entryView => entryView.render());\n\n        /*\n         * Navigate to the right anchor on the page, if there's a valid hash\n         * in the URL. We'll also do this whenever it changes, if the browser\n         * supports this.\n         */\n        this._onHashChanged();\n\n        if ('onhashchange' in window) {\n            window.onhashchange = this._onHashChanged.bind(this);\n        }\n\n        /*\n         * Load all the diff fragments queued up in each review.\n         */\n        this.diffFragmentQueue.loadFragments();\n\n        /*\n         * Set up the Issue Summary Table and begin listening for related\n         * events.\n         */\n        this._issueSummaryTableView =\n            new RB.ReviewRequestPage.IssueSummaryTableView({\n                el: $('#issue-summary'),\n                model: this.model.commentIssueManager,\n            });\n\n        this._issueSummaryTableView.render();\n\n        this.listenTo(this._issueSummaryTableView,\n                      'issueClicked',\n                      this._onIssueClicked);\n        this.listenTo(this.model, 'appliedUpdate:issue-summary-table',\n                      (metadata, html) => {\n            this._reloadView(this._issueSummaryTableView, html);\n        });\n\n        this._rendered = true;\n\n        return this;\n    },\n\n    /**\n     * Add a new entry and view to the page.\n     *\n     * Args:\n     *     entryView (RB.ReviewRequestPage.EntryView):\n     *         The new entry's view to add.\n     */\n    addEntryView(entryView) {\n        const entry = entryView.model;\n\n        this._entryViews.push(entryView);\n        this._entryViewsByID[entry.id] = entryView;\n        this.model.addEntry(entry);\n\n        if (this._rendered) {\n            entryView.render();\n        }\n    },\n\n    /**\n     * Queue a diff fragment for loading.\n     *\n     * The diff fragment will be part of a comment made on a diff.\n     *\n     * Args:\n     *     commentID (string):\n     *         The ID of the comment to load the diff fragment for.\n     *\n     *     key (string):\n     *         Either a single filediff ID, or a pair (filediff ID and\n     *         interfilediff ID) separated by a hyphen.\n     *\n     *     onFragmentRendered (function, optional):\n     *         Optional callback for when the view for the fragment has\n     *         rendered. Contains the view as a parameter.\n     */\n    queueLoadDiff(commentID, key, onFragmentRendered) {\n        this.diffFragmentQueue.queueLoad(commentID, key, onFragmentRendered);\n    },\n\n    /**\n     * Open a comment editor for the given comment.\n     *\n     * This is used when clicking Reply from a comment dialog on another\n     * page.\n     *\n     * Args:\n     *     contextType (string):\n     *         The type of object being edited (such as ``body_top`` or\n     *         ``diff_comments``)\n     *\n     *     contextID (number, optional):\n     *         The ID of the comment being edited, if appropriate.\n     */\n    openCommentEditor(contextType, contextID) {\n        for (let i = 0; i < this._entryViews.length; i++) {\n            const entryView = this._entryViews[i];\n            const reviewReplyEditorView = (\n                _.isFunction(entryView.getReviewReplyEditorView)\n                ? entryView.getReviewReplyEditorView(contextType, contextID)\n                : null);\n\n            if (reviewReplyEditorView) {\n                reviewReplyEditorView.openCommentEditor();\n                break;\n            }\n        }\n    },\n\n    /**\n     * Reload the HTML for a view.\n     *\n     * This will replace the view's element with a new one consisting of the\n     * provided HTML. This is done in response to an update from the server.\n     *\n     * Args:\n     *     view (Backbone.View):\n     *         The view to set new HTML for.\n     *\n     *     html (string):\n     *         The new HTML to set.\n     */\n    _reloadView(view, html) {\n        const $oldEl = view.$el;\n        const $newEl = $(html);\n\n        view.setElement($newEl);\n        $oldEl.replaceWith($newEl);\n        view.render();\n    },\n\n    /**\n     * Handler for when a new update is being applied to a view.\n     *\n     * This will call the ``beforeApplyUpdate`` method on the view, if it\n     * exists. This is called before the model's equivalent handler.\n     *\n     * Args:\n     *     view (Backbone.View):\n     *         The view being updated.\n     *\n     *     metadata (object):\n     *         The metadata set in the update.\n     */\n    _onApplyingUpdate(view, metadata) {\n        if (view && _.isFunction(view.beforeApplyUpdate)) {\n            view.beforeApplyUpdate(metadata);\n        }\n    },\n\n    /**\n     * Handler for when a new update has been applied to a view.\n     *\n     * This will call the ``afterApplyUpdate`` method on the view, if it\n     * exists. This is called after the model's equivalent handler.\n     *\n     * Args:\n     *     view (Backbone.View):\n     *         The view that has been updated.\n     *\n     *     metadata (object):\n     *         The metadata set in the update.\n     */\n    _onAppliedUpdate(view, metadata) {\n        if (view && _.isFunction(view.afterApplyUpdate)) {\n            view.afterApplyUpdate(metadata);\n        }\n    },\n\n    /**\n     * Handler for when the location hash changes.\n     *\n     * This will attempt to locate a proper anchor point for the given\n     * hash, if one is provided, and scroll down to that anchor. The\n     * scrolling will take any docked floating banners (the review draft,\n     * specifically) into consideration to ensure the entirety of the comment\n     * is shown on-screen.\n     */\n    _onHashChanged() {\n        const hash = RB.getLocationHash();\n        let selector = null;\n\n        if (hash !== '') {\n            if (hash.includes('comment')) {\n                selector = `a[name=${hash}]`;\n            } else {\n                selector = `#${hash}`;\n            }\n        }\n\n        if (!selector) {\n            return;\n        }\n\n        /*\n         * If trying to link to some anchor in some entry, we'll expand the\n         * first entry containing that anchor.\n         */\n        for (let i = 0; i < this._entryViews.length; i++) {\n            const entryView = this._entryViews[i];\n            const $anchor = entryView.$(selector);\n\n            if ($anchor.length > 0) {\n                /*\n                 * We found the entry containing the specified anchor.\n                 * Expand it and stop searching the rest of the entries.\n                 */\n                entryView.expand();\n\n                /*\n                 * Scroll down to the particular anchor, now that the entry\n                 * is expanded.\n                 */\n                RB.scrollManager.scrollToElement($anchor);\n                break;\n            }\n        }\n    },\n\n    /**\n     * Handle a press on the Collapse All button.\n     *\n     * Collapses each entry.\n     *\n     * Args:\n     *     e (Event):\n     *         The event which triggered the action.\n     */\n    _onCollapseAllClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._entryViews.forEach(entryView => entryView.collapse());\n    },\n\n    /**\n     * Handle a press on the Expand All button.\n     *\n     * Expands each entry.\n     *\n     * Args:\n     *     e (Event):\n     *         The event which triggered the action.\n     */\n    _onExpandAllClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._entryViews.forEach(entryView => entryView.expand());\n    },\n\n    /**\n     * Handler for when an issue in the issue summary table is clicked.\n     *\n     * This will expand the review entry that contains the comment for the\n     * issue, and navigate to the comment.\n     *\n     * Args:\n     *     params (object):\n     *         Parameters passed to the event handler.\n     */\n    _onIssueClicked(params) {\n        const prefix = commentTypeToIDPrefix[params.commentType];\n        const selector = `#${prefix}comment${params.commentID}`;\n\n        this._entryViews.forEach(entryView => {\n            if (entryView.$el.find(selector).length > 0) {\n                entryView.expand();\n            }\n        });\n\n        window.location = params.commentURL;\n    },\n});\n\n\n})();\n"]}
{"version":3,"sources":["reviewEntryView.es6.js"],"names":[],"mappings":"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","file":"reviewEntryView.js","sourcesContent":["(function() {\n\n\nconst ParentView = RB.ReviewRequestPage.EntryView;\n\n\n/**\n * Displays a review with discussion on the review request page.\n *\n * Review boxes contain discussion on parts of a review request. This includes\n * comments, screenshots, and file attachments.\n */\nRB.ReviewRequestPage.ReviewEntryView = ParentView.extend({\n    events: _.defaults({\n        'click .revoke-ship-it': '_revokeShipIt',\n    }, ParentView.prototype.events),\n\n    /**\n     * Initialize the view.\n     */\n    initialize() {\n        ParentView.prototype.initialize.call(this);\n\n        this._reviewView = null;\n        this._draftBannerShown = false;\n        this._$boxStatus = null;\n        this._$fixItLabel = null;\n        this._$shipItLabel = null;\n    },\n\n    /**\n     * Save state before applying an update from the server.\n     *\n     * This will save all the loaded diff fragments on the entry so that\n     * they'll be loaded from cache when processing the fragments again for\n     * the entry after reload.\n     */\n    beforeApplyUpdate() {\n        const diffFragmentQueue = RB.PageManager.getPage().diffFragmentQueue;\n        const diffCommentsData = this.model.get('diffCommentsData');\n\n        for (let i = 0; i < diffCommentsData.length; i++) {\n            diffFragmentQueue.saveFragment(diffCommentsData[i][0]);\n        }\n    },\n\n    /**\n     * Render the review box.\n     *\n     * This will prepare a reply draft banner, used if the user is replying\n     * to any comments on the review.\n     *\n     * Each comment section will be set up to allow discussion.\n     *\n     * Returns:\n     *     RB.ReviewRequestPage.ReviewEntryView:\n     *     This object, for chaining.\n     */\n    render() {\n        ParentView.prototype.render.call(this);\n\n        this._reviewView = new RB.ReviewRequestPage.ReviewView({\n            el: this.el,\n            model: this.model.get('review'),\n            entryModel: this.model,\n            $bannerFloatContainer: this._$box,\n            $bannerParent: this.$('.banners'),\n            bannerNoFloatContainerClass: 'collapsed',\n        });\n\n        this._$boxStatus = this.$('.box-status');\n        this._$fixItLabel = this._$boxStatus.find('.fix-it-label');\n        this._$shipItLabel = this._$boxStatus.find('.ship-it-label');\n\n        this.listenTo(this._reviewView, 'hasDraftChanged',\n                      hasDraft => this.$el.toggleClass('has-draft', hasDraft));\n        this.listenTo(this._reviewView, 'openIssuesChanged',\n                      this._updateLabels);\n\n        this._reviewView.render();\n        this._updateLabels();\n\n        return this;\n    },\n\n    /**\n     * Return the ReviewReplyEditorView with the given context type and ID.\n     *\n     * Args:\n     *     contextType (string):\n     *         The type of object being replied to (such as ``body_top`` or\n     *         ``diff_comments``)\n     *\n     *     contextID (number, optional):\n     *         The ID of the comment being replied to, if appropriate.\n     *\n     * Returns:\n     *     RB.ReviewRequestPage.ReviewReplyEditorView:\n     *     The matching editor view.\n     */\n    getReviewReplyEditorView(contextType, contextID) {\n        return this._reviewView.getReviewReplyEditorView(contextType,\n                                                         contextID);\n    },\n\n    /**\n     * Update the \"Ship It\" and \"Fix It\" labels based on the open issue counts.\n     *\n     * If there are open issues, there will be a \"Fix it!\" label.\n     *\n     * If there's a Ship It, there will be a \"Ship it!\" label.\n     *\n     * If there's both a Ship It and open issues, the \"Fix it!\" label will\n     * be shown overlaid on top of the \"Ship it!\" label, and will go away\n     * once the issues are resolved.\n     */\n    _updateLabels() {\n        this._updateLabel(this._$fixItLabel,\n                          this._reviewView.hasOpenIssues(),\n                          'has-issues');\n        this._updateLabel(this._$shipItLabel,\n                          this.model.get('review').get('shipIt'),\n                          'ship-it');\n    },\n\n    /**\n     * Update the visibility of a label.\n     *\n     * The label's position and opacity will be set based on whether the\n     * label is intended to be visible. The label status box's CSS classes will\n     * also be updated based on the visibility and the provided CSS class name.\n     *\n     * Combined with CSS rules, the label will transition the opacity and\n     * the position.\n     *\n     * Args:\n     *     $label (jQuery):\n     *         The label element.\n     *\n     *     visible (boolean):\n     *         Whether the label should be shown as visible.\n     *\n     *     boxClassName (string):\n     *         The CSS class to add to or remove from the status box.\n     */\n    _updateLabel($label, visible, boxClassName) {\n        if (visible) {\n            this._$boxStatus.addClass(boxClassName);\n            $label\n                .show()\n                .css({\n                    opacity: 1,\n                    left: 0,\n                });\n        } else {\n            $label.css({\n                opacity: 0,\n                left: '-100px',\n            });\n            this._$boxStatus.removeClass(boxClassName);\n        }\n    },\n\n    /**\n     * Revoke the Ship It on the review.\n     *\n     * This will first confirm that the user does want to revoke the Ship It.\n     * If they confirm, the Ship It will be removed via an API call.\n     */\n    _revokeShipIt() {\n        this._$boxStatus.addClass('revoking-ship-it');\n\n        const confirmation =\n            RB.ReviewRequestPage.ReviewEntryView.strings.revokeShipItConfirm;\n\n        if (!confirm(confirmation)) {\n            this._clearRevokingShipIt();\n            return;\n        }\n\n        const review = this.model.get('review');\n\n        review.ready({\n            ready: () => {\n                review.set('shipIt', false);\n                review.save({\n                    attrs: ['shipIt', 'includeTextTypes'],\n                    success: () => {\n                        this._updateLabels();\n\n                        /*\n                         * Add a delay before removing this, so that the\n                         * animation won't be impacted. This will encompass\n                         * the length of the animation.\n                         */\n                        setTimeout(() => this._clearRevokingShipIt(), 900);\n                    },\n                    error: (model, xhr) => {\n                        review.set('shipIt', true);\n                        this._clearRevokingShipIt();\n\n                        alert(xhr.responseJSON.err.msg);\n                    },\n                });\n            },\n        });\n    },\n\n    /**\n     * Clear the Revoke Ship It state.\n     *\n     * This will clear the CSS classes related to the revokation.\n     */\n    _clearRevokingShipIt() {\n        this._$boxStatus.removeClass('revoking-ship-it');\n    },\n}, {\n    strings: {\n        revokeShipItConfirm: gettext('Are you sure you want to revoke this Ship It?\\n\\nThis cannot be undone.'),\n    },\n});\n\n\n})();\n"]}
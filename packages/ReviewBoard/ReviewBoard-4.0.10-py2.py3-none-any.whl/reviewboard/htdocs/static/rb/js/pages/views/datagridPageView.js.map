{"version":3,"sources":["datagridPageView.es6.js"],"names":[],"mappings":"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","file":"datagridPageView.js","sourcesContent":["/**\n * Manages the UI for the page containing a main datagrid.\n *\n * This renders the datagrid, handles events, and allows for multi-row\n * actions.\n */\nRB.DatagridPageView = RB.PageView.extend({\n    RELOAD_INTERVAL_MS: 5 * 60 * 1000,\n\n    /* The View class to use for an actions menu, if any. */\n    actionsViewType: null,\n\n    events: {\n        'change tbody input[data-checkbox-name=select]': '_onRowSelected',\n        'reloaded .datagrid-wrapper': '_setupDatagrid',\n    },\n\n    /**\n     * Initialize the datagrid page.\n     *\n     * Args:\n     *     options (object, optional):\n     *         Options for the view.\n     *\n     * Option Args:\n     *     periodicReload (boolean):\n     *         Whether to periodically reload the contents of the datagrid.\n     */\n    initialize(options={}) {\n        RB.PageView.prototype.initialize.call(this, options);\n\n        this.periodicReload = !!options.periodicReload;\n\n        this._reloadTimer = null;\n        this._datagrid = null;\n        this._$wrapper = null;\n        this._$datagridBody = null;\n        this._$datagridBodyContainer = null;\n        this._menuShown = false;\n    },\n\n    /**\n     * Render the datagrid page view, and begins listening for events.\n     */\n    renderPage() {\n        RB.InfoboxManagerView.getInstance().setPositioning(\n            RB.ReviewRequestInfoboxView,\n            {\n                /*\n                 * The order on the side matters. If the Summary column is\n                 * on the left-hand side of the datagrid, and \"l\" is first,\n                 * it can end up taking priority, even if \"L\" was a better\n                 * fit (since, if the infobox would need to be pushed a bit\n                 * to fit on screen, it will prefer \"l\"). If the column is on\n                 * the right-hand side of the dashboard, it will prefer \"l\",\n                 * given the room available (taking into account the sidebar).\n                 *\n                 * So \"L\" is a better priority for the common use, and \"l\"\n                 * works well as a fallback.\n                 */\n                side: 'Ll',\n                LDistance: 300,\n                lDistance: 20,\n                yOffset: -20,\n            });\n\n        if (this.actionsViewType) {\n            this._setupActionsDrawer();\n        }\n\n        this.listenTo(this.model, 'refresh', () => this._reload(false));\n\n        this._setupDatagrid();\n\n        if (this.periodicReload) {\n            this._startReloadTimer();\n        }\n\n        return this;\n    },\n\n    /**\n     * Handle page resizes.\n     *\n     * This will update the datagrid to fit on the page after a resize.\n     */\n    onResize() {\n        if (this._datagrid !== null) {\n            this._datagrid.resizeToFit();\n        }\n    },\n\n    /**\n     * Set up the actions pane view.\n     */\n    _setupActionsDrawer() {\n        const drawer = new RB.DrawerView();\n        this.setDrawer(drawer);\n\n        this._actionsView = new this.actionsViewType({\n            model: this.model,\n            datagridView: this,\n        });\n        this._actionsView.render().$el.appendTo(drawer.$content);\n\n        this.listenTo(this.model, 'change:count', (model, count) => {\n            const showMenu = (count > 0);\n\n            if (showMenu === this._menuShown) {\n                return;\n            }\n\n            if (showMenu) {\n                this._showActions();\n\n                /*\n                 * Don't reload the datagrid while the user is\n                 * preparing any actions.\n                 */\n                this._stopReloadTimer();\n            } else {\n                this._hideActions();\n\n                if (this.periodicReload) {\n                    this._startReloadTimer();\n                }\n            }\n\n            this._menuShown = showMenu;\n        });\n    },\n\n    /**\n     * Set up parts of the datagrid.\n     *\n     * This will reference elements inside the datagrid and set up UI.\n     * This is called when first rendering the datagrid, and any time\n     * the datagrid is reloaded from the server.\n     */\n    _setupDatagrid() {\n        this._$wrapper = this.$('#content_container');\n        this._$datagrid = this._$wrapper.find('.datagrid-wrapper');\n        this._datagrid = this._$datagrid.data('datagrid');\n        this._$main = this._$wrapper.find('.datagrid-main');\n\n        this.$('time.timesince').timesince();\n        this.$('.user').user_infobox();\n        this.$('.bugs').find('a').bug_infobox();\n        this.$('.review-request-link').review_request_infobox();\n\n        this.model.clearSelection();\n\n        _.each(this.$('input[data-checkbox-name=select]:checked'),\n               checkbox => this.model.select($(checkbox).data('object-id')));\n\n        if (RB.UserSession.instance.get('authenticated')) {\n            this._starManager = new RB.StarManagerView({\n                model: new RB.StarManager(),\n                el: this._$main,\n                datagridMode: true,\n            });\n        }\n\n        this._$datagrid\n            .on('reloaded', this._setupDatagrid.bind(this))\n            .on('datagridDisplayModeChanged',\n                this._reselectBatchCheckboxes.bind(this));\n        this._datagrid.resizeToFit();\n    },\n\n    /**\n     * Re-select any checkboxes that are part of the current selection.\n     *\n     * When the datagrid transitions between mobile and desktop modes,\n     * we use two different versions of the table, meaning two sets of\n     * checkboxes. This function updates the checkbox selection based on the\n     * currently selected items.\n     */\n    _reselectBatchCheckboxes() {\n        const checkboxMap = {};\n\n        this.$('input[data-checkbox-name=select]').each((idx, checkboxEl) => {\n            if (checkboxEl.checked) {\n                checkboxEl.checked = false;\n            }\n\n            checkboxMap[checkboxEl.dataset.objectId] = checkboxEl;\n        });\n\n        this.model.selection.each(selection => {\n            checkboxMap[selection.id].checked = true;\n        });\n    },\n\n    /**\n     * Show the actions drawer.\n     */\n    _showActions() {\n        this.drawer.show();\n    },\n\n    /**\n     * Hide the actions drawer.\n     */\n    _hideActions() {\n        this.drawer.hide();\n    },\n\n    /**\n     * Start the reload timer, if it's not already running.\n     */\n    _startReloadTimer() {\n        if (!this._reloadTimer) {\n            this._reloadTimer = setInterval(this._reload.bind(this),\n                                            this.RELOAD_INTERVAL_MS);\n        }\n    },\n\n    /**\n     * Stop the reload timer, if it's running.\n     */\n    _stopReloadTimer() {\n        if (this._reloadTimer) {\n            window.clearInterval(this._reloadTimer);\n            this._reloadTimer = null;\n        }\n    },\n\n    /**\n     * Reload the datagrid contents.\n     *\n     * This may be called periodically to reload the contents of the\n     * datagrid, if specified by the subclass.\n     *\n     * Args:\n     *     periodicReload (boolean):\n     *         Whether the datagrid should reload periodically.\n     */\n    _reload(periodicReload) {\n        const $editCols = this.$('.edit-columns');\n\n        if (periodicReload === false) {\n            this._stopReloadTimer();\n        }\n\n        this.model.clearSelection();\n\n        $editCols\n            .width($editCols.width() - $editCols.getExtents('b', 'lr'))\n            .html('<span class=\"fa fa-spinner fa-pulse\"></span>');\n\n        this._$wrapper.load(window.location + ' #content_container', () => {\n            this.$('.datagrid-wrapper').datagrid();\n\n            this._setupDatagrid();\n\n            if (periodicReload !== false) {\n                this._startReloadTimer();\n            }\n        });\n    },\n\n    /**\n     * Handler for when a row is selected.\n     *\n     * Records the row for any actions the user may wish to invoke.\n     *\n     * Args:\n     *     e (Event):\n     *         The event that triggered the callback.\n     */\n    _onRowSelected(e) {\n        const $checkbox = $(e.target);\n        const objectID = $checkbox.data('object-id');\n\n        if ($checkbox.prop('checked')) {\n            this.model.select(objectID);\n        } else {\n            this.model.unselect(objectID);\n        }\n    },\n});\n"]}
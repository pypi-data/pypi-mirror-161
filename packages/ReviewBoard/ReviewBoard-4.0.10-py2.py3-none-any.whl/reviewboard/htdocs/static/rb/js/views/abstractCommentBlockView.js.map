{"version":3,"sources":["abstractCommentBlockView.es6.js"],"names":[],"mappings":"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","file":"abstractCommentBlockView.js","sourcesContent":["RB.AbstractCommentBlockView = Backbone.View.extend({\n    events: {\n        'click': '_onClicked'\n    },\n\n    tooltipSides: 'lrbt',\n\n    /**\n     * Dispose the comment block.\n     *\n     * This will remove the view and the tooltip.\n     */\n    dispose() {\n        this.trigger('removing');\n        this.remove();\n        this._$tooltip.remove();\n    },\n\n    /**\n     * Render the comment block.\n     *\n     * Along with the block, a floating tooltip will be created that\n     * displays summaries of the comments.\n     *\n     * Returns:\n     *     RB.AbstractCommentBlockView:\n     *     This object, for chaining.\n     */\n    render() {\n        this._$tooltip = $.tooltip(this.$el, { side: this.tooltipSides })\n            .addClass('comments');\n\n        this.renderContent();\n\n        this.model.on('change:draftComment', this._onDraftCommentChanged, this);\n        this._onDraftCommentChanged();\n\n        this._updateTooltip();\n\n        return this;\n    },\n\n    /**\n     * Hide the tooltip from the page.\n     *\n     * This will force the tooltip to hide, preventing it from interfering\n     * with operations such as moving a comment block.\n     *\n     * It will automatically show again the next time there is a mouse enter\n     * event.\n     */\n    hideTooltip() {\n        this._$tooltip.hide();\n    },\n\n    /**\n     * Position the comment dlg to the right side of comment block.\n     *\n     * This can be overridden to change where the comment dialog will\n     * be displayed.\n     *\n     * Args:\n     *     commntDlg (RB.CommentDialogView):\n     *          The view for the comment dialog.\n     */\n    positionCommentDlg(commentDlg) {\n        commentDlg.positionBeside(this.$el, {\n            side: 'r',\n            fitOnScreen: true\n        });\n    },\n\n    /**\n     * Position the notification bubble around the comment block.\n     *\n     * This can be overridden to change where the bubble will be displayed.\n     * By default, it is centered over the block.\n     *\n     * Args:\n     *     $bubble (jQuery):\n     *         The selector for the notification bubble.\n     */\n    positionNotifyBubble($bubble) {\n        $bubble.move(Math.round((this.$el.width()  - $bubble.width())  / 2),\n                     Math.round((this.$el.height() - $bubble.height()) / 2));\n    },\n\n    /**\n     * Notify the user of some update.\n     *\n     * This notification appears in the comment area.\n     *\n     * Args:\n     *     text (string):\n     *         The text to show in the notification.\n     *\n     *     cb (function, optional):\n     *         A callback function to call once the notification has been\n     *         removed.\n     *\n     *     context (object):\n     *         Context to bind when calling the ``cb`` callback function.\n     */\n    notify(text, cb, context) {\n        const $bubble = $('<div class=\"bubble\">')\n            .css('opacity', 0)\n            .appendTo(this.$el)\n            .text(text);\n\n        this.positionNotifyBubble($bubble);\n\n        $bubble\n            .animate({\n                top: '-=10px',\n                opacity: 0.8,\n            }, 350, 'swing')\n            .delay(1200)\n            .animate({\n                top: '+=10px',\n                opacity: 0,\n            }, 350, 'swing', () => {\n                $bubble.remove();\n\n                if (_.isFunction(cb)) {\n                    cb.call(context);\n                }\n            });\n    },\n\n    /**\n     * Update the tooltip contents.\n     *\n     * The contents will show the summary of each comment, including\n     * the draft comment, if any.\n     */\n    _updateTooltip() {\n        const $list = $('<ul/>');\n        const draftComment = this.model.get('draftComment');\n        const tooltipTemplate = _.template(dedent`\n            <li>\n             <div class=\"reviewer\">\n              <%- user %>:\n             </div>\n             <pre class=\"rich-text\"><%= html %></pre>\n            </li>\n        `);\n\n        if (draftComment) {\n            $(tooltipTemplate({\n                user: RB.UserSession.instance.get('fullName'),\n                html: draftComment.get('html'),\n            }))\n            .addClass('draft')\n            .appendTo($list);\n        }\n\n        this.model.get('serializedComments').forEach(comment => {\n            $(tooltipTemplate({\n                user: comment.user.name,\n                html: comment.html,\n            }))\n            .appendTo($list);\n        });\n\n        this._$tooltip\n            .empty()\n            .append($list);\n    },\n\n    /**\n     * Handle changes to the model's draftComment property.\n     *\n     * If there's a new draft comment, we'll begin listening for updates\n     * on it in order to update the tooltip or display notification bubbles.\n     *\n     * The comment block's style will reflect whether or not we have a\n     * draft comment.\n     *\n     * If the draft comment is deleted, and there are no other comments,\n     * the view will be removed.\n     */\n    _onDraftCommentChanged() {\n        const comment = this.model.get('draftComment');\n\n        if (!comment) {\n            this.$el.removeClass('draft');\n            return;\n        }\n\n        comment.on('change:text', this._updateTooltip, this);\n\n        comment.on('destroy', () => {\n            this.notify(gettext('Comment Deleted'), () => {\n                // Discard the comment block if empty.\n                if (this.model.isEmpty()) {\n                    this.$el.fadeOut(350, () => this.dispose());\n                } else {\n                    this.$el.removeClass('draft');\n                    this._updateTooltip();\n                }\n            });\n        });\n\n        comment.on('saved', options => {\n            this._updateTooltip();\n\n            if (!options.boundsUpdated) {\n                this.notify(gettext('Comment Saved'));\n            }\n\n            RB.DraftReviewBannerView.instance.show();\n        });\n\n        this.$el.addClass('draft');\n    },\n\n    /**\n     * Handle the comment block being clicked.\n     *\n     * Emits the 'clicked' signal so that parent views can process it.\n     */\n    _onClicked() {\n        this.trigger('clicked');\n    },\n});\n"]}